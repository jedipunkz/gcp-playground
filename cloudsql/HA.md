# GCP Cloud SQL高可用性(HA)構成パターン

## 概要
GCP Cloud SQLの高可用性構成は、データベースの可用性とデータ保護を向上させるための複数のパターンを提供します。各構成パターンには異なる特性とTerraformリソースが使用されます。セキュリティを重視し、VPCプライベートネットワーク経由でのアクセス、カスタマー暗号鍵（CMEK）、IAM権限管理を含む包括的な構成を示します。

## 構成パターン

### 1. Regional Persistent Disk HA構成 (`regional-ha/`)

**概要**: 同一リージョン内の2つのゾーンにわたる同期レプリケーションを使用した基本的なHA構成。プライマリインスタンスとスタンバイインスタンスが異なるゾーンに配置され、約60秒での自動フェイルオーバーを提供。VPCプライベート接続、SSL強制、Cloud KMS暗号化、IAM認証を含むセキュアな設定。RPO=0、RTO=60秒の高可用性を実現し、本番環境での基本的なHA要件を満たす構成。

**特徴**:
- 同期レプリケーション（RPO: 0）
- 自動フェイルオーバー（RTO: ~60秒）
- 共有静的IPアドレス
- VPCプライベート接続のみ
- Cloud KMS暗号化対応

### 2. Read Replica構成 (`read-replica/`)

**概要**: プライマリインスタンスに加えて複数の読み取り専用レプリカを配置し、読み取りワークロードを分散する構成。レプリカは同一リージョンの異なるゾーンに配置され、読み取りパフォーマンスの向上とスケーリングを実現。プライマリで書き込み、レプリカで読み取りを処理することで、高いスループットを達成。自動フェイルオーバーは提供されないため、アプリケーション側での制御が必要。

**特徴**:
- 最大10個の直接レプリカ
- 読み取りパフォーマンス向上
- 非同期レプリケーション
- 自動フェイルオーバーなし
- ゾーン分散配置

### 3. Cross-Region Replica構成 (`cross-region-replica/`)

**概要**: 異なるリージョンにレプリカを配置することで災害復旧（DR）とグローバルな読み取りパフォーマンス向上を実現する構成。プライマリリージョンとDRリージョンにそれぞれ独立したVPCとKMS暗号化キーを配置し、リージョン間の障害に対する耐性を提供。手動フェイルオーバーによる災害復旧が可能で、グローバルアプリケーションでの読み取り最適化にも対応。

**特徴**:
- 異なるリージョンのレプリカ
- 災害復旧機能
- グローバル読み取り最適化
- リージョン別VPCとKMS
- 手動フェイルオーバー

### 4. Read Replica Autoscaling構成 (`read-replica-autoscaling/`)

**概要**: メトリクス監視に基づいてRead Replicaを動的に作成・削除する自動スケーリング構成。CPU使用率、接続数、レプリケーションラグを監視し、Cloud Functionsが5分間隔で評価してスケーリング判断を実行。Cloud Schedulerでの定期実行とPub/Subでのイベント駆動により、トラフィック変動に応じた柔軟なリソース調整を実現。コスト効率と性能最適化を両立する構成。

**特徴**:
- CPU/接続数/レプリケーションラグ監視
- Cloud Functions自動スケーリング
- 5分間隔の定期評価
- Pub/Subイベント駆動
- 動的リソース調整

### 5. Connection Pooling + Load Balancing構成 (`connection-pooling-lb/`)

**概要**: PgBouncerコネクションプーリングとInternal Load Balancerを組み合わせた接続最適化構成。複数のPgBouncerインスタンスが内部ロードバランサー経由で書き込み・読み取りトラフィックを分散し、データベース接続数を効率管理。最大1000クライアント接続を20プールサイズで処理し、健全性チェックによる自動故障検出で高可用性を実現。大規模アプリケーションの接続効率化に最適。

**特徴**:
- PgBouncerコネクションプーリング
- 書き込み・読み取り別ロードバランサー
- 最大1000クライアント接続対応
- 健全性チェック自動故障検出
- 接続効率最適化

### 6. Enhanced Backup構成 (`enhanced-backup/`)

**概要**: 標準バックアップに加えて、集中化されたバックアップ管理とBackup Vaultでの長期保存（最大99年）を提供する構成。プロジェクト横断でのバックアップ管理が可能で、コンプライアンス要件や長期保存ニーズに対応。日次、週次、月次などの柔軟なスケジュール設定と、ポイントインタイム復旧により、包括的なデータ保護戦略を実現する企業向け構成。

**特徴**:
- 集中化バックアップ管理
- Backup Vault長期保存
- 最大99年保存期間
- プロジェクト横断管理
- 柔軟なスケジュール設定

## セキュリティ考慮事項

### ネットワークセキュリティ
- **VPCプライベート接続**: パブリックIPを無効化し、VPC内からのみアクセス
- **SSL/TLS暗号化**: すべての接続でSSLを強制、ENCRYPTED_ONLYモード
- **ファイアウォールルール**: VPCファイアウォールでアクセス制限

### データ暗号化
- **CMEK**: カスタマー管理の暗号化キーでディスク暗号化
- **キーローテーション**: 定期的な暗号化キーのローテーション
- **リージョン別キー**: 各リージョンで異なる暗号化キーを使用

### アクセス制御
- **IAM認証**: Cloud IAMでのデータベースアクセス
- **最小権限の原則**: 必要最小限の権限のみ付与
- **サービスアカウント**: アプリケーション専用のサービスアカウント

### 監視とログ
- **Cloud SQL Insights**: クエリパフォーマンスの監視
- **Cloud Audit Logs**: 管理操作の監査ログ
- **VPC Flow Logs**: ネットワークトラフィックの監視

## 構成選択の指針

| 要件 | 推奨構成 | RTO/RPO | セキュリティ特徴 |
|------|---------|---------|----------------|
| 基本的なHA | Regional Persistent Disk | RTO: ~60秒, RPO: 0 | VPCプライベート, CMEK |
| 読み取りスケーリング | Read Replica | N/A（読み取り専用） | プライベートネットワーク, SSL強制 |
| 災害復旧 | Cross-Region Replica | RTO: 手動, RPO: 数分 | リージョン別CMEK, 分離VPC |
| グローバル展開 | Cascading Replica | RTO: 手動, RPO: 数分 | マルチリージョン暗号化 |
| 長期バックアップ | Enhanced Backup | RTO: 数時間, RPO: 設定次第 | 集中管理, 長期保存 |

## デプロイ方法

### 使用方法
```bash
# 例：Regional HA構成をデプロイ
cd regional-ha
cp terraform.tfvars.example terraform.tfvars
# terraform.tfvarsを編集してproject_idとdb_passwordを設定
terraform init
terraform plan
terraform apply
```

### 必要な設定
各構成の`terraform.tfvars.example`をコピーして以下を設定：
- `project_id`: GCPプロジェクトID
- `db_password`: データベースパスワード
- その他オプション設定（リージョン、インスタンスサイズなど）

## コスト考慮事項

### インスタンスコスト
- **Regional HA**: 標準インスタンスの2倍のコスト
- **Read Replica**: 各レプリカは標準インスタンスと同等のコスト
- **Cross-Region Replica**: リージョン間ネットワーク料金が追加

### セキュリティ関連コスト
- **Cloud KMS**: 暗号化キーの作成・ローテーション料金
- **VPC**: プライベートサービス接続の維持費
- **Monitoring**: Cloud Monitoringでのメトリクス収集料金

### バックアップコスト
- **Enhanced Backup**: Backup Vault使用料金とストレージ料金
- **Cross-Region Backup**: リージョン間コピー料金

## 制限事項と注意点

### 技術的制限
- **レガシーHA**: 2025年1月に廃止予定
- **Enhanced Backup**: Disaster Recovery replicaと併用不可
- **Backup Vault**: インスタンスと同一リージョンに配置必要
- **Read Replica**: 自動フェイルオーバーを提供しない

### セキュリティ制限
- **CMEKキー**: 暗号化キーの削除はデータアクセス不能を引き起こす
- **VPCピアリング**: 同一プロジェクト内のVPC間のみ可能
- **SSL証明書**: 定期的なローテーションが必要
- **IAM権限**: サービスアカウントの権限管理が重要

## ベストプラクティス

### セキュリティ
1. **ネットワーク分離**: プロダクションと開発環境の完全分離
2. **最小権限**: アプリケーションに必要最小限の権限のみ付与
3. **監視強化**: アクセスログとパフォーマンスメトリクスの継続監視
4. **定期ローテーション**: パスワード、SSL証明書、暗号化キーの定期更新

### 運用
1. **自動化**: Terraformでのインフラ管理とCI/CD統合
2. **バックアップ検証**: 定期的なリストアテストの実施
3. **災害復旧計画**: RTO/RPO目標に基づいた復旧手順の文書化
4. **パフォーマンスチューニング**: 継続的なパフォーマンス監視と最適化